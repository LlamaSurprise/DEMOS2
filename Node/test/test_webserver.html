<!DOCTYPE html>
<html>
<body>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery.js"></script>
<!-- Bootstrap core JavaScript -->
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>


<!-- Crypto JS -->
    <script type="text/javascript" src=./core/rand.js></script>
    <script type="text/javascript" src=./core/rom_curve.js></script>
    <script type="text/javascript" src=./core/rom_field.js></script>
    <script type="text/javascript" src=./core/uint64.js></script>
    <script type="text/javascript" src=./core/aes.js></script>
    <script type="text/javascript" src=./core/big.js></script>
    <script type="text/javascript" src=./core/gcm.js></script>
    <script type="text/javascript" src=./core/hash256.js></script>
    <script type="text/javascript" src=./core/hash384.js></script>
    <script type="text/javascript" src=./core/hash512.js></script>
    <script type="text/javascript" src=./core/sha3.js></script>
    <script type="text/javascript" src=./core/newhope.js></script>
    <script type="text/javascript" src=./core/nhs.js></script>
    <script type="text/javascript" src=./core/fp.js></script>
    <script type="text/javascript" src=./core/fp2.js></script>
    <script type="text/javascript" src=./core/fp4.js></script>
    <script type="text/javascript" src=./core/fp12.js></script>
    <script type="text/javascript" src=./core/ff.js></script>
    <script type="text/javascript" src=./core/rsa.js></script>
    <script type="text/javascript" src=./core/ecp.js></script>
    <script type="text/javascript" src=./core/ecp2.js></script>
    <script type="text/javascript" src=./core/ecdh.js></script>
    <script type="text/javascript" src=./core/pair.js></script>
    <script type="text/javascript" src=./core/mpin.js></script>
    <script type="text/javascript" src=./core/ctx.js></script>

    <script type="text/javascript" src="demos2-booth.js"></script>

<h1>DEMOS2 Node.js Server testing page</h1>

<button type="button" id="gpGen" class="btn">gpGen</button>
<p id="gpGenLocal">GPGen Local results</p>
<p id="gpGenServer">GPGen Server results</p>

<button type="button" id="addec" class="btn">addec</button>
<p id="addecLocal">addec Local results</p>
<p id="addecServer">addec Server results</p>
<p id="addecResult">addec comparison results</p>

<script>
$(document).ready(function(){

	$("#gpGen").click(function(){

		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			  document.getElementById("gpGenServer").innerHTML = this.responseText;

			  var params = gpGen();
			  document.getElementById("gpGenLocal").innerHTML = JSON.stringify(params);
			}
		};
		xhttp.open("GET", "/param", true);
		xhttp.send();
	})

	var params = gpGen(); 
    var keys = keyGen(params);

    var cipher = encrypt(params,keys.PK, 5);
    var string_c1 = cipher.C1.toString();

    //test decrypt
    var message = decrypt(params, keys.SK, cipher);

    //test combine key
    var k1 = keyGen(params);
    var k2 = keyGen(params);

    var PKs = new Array(k1.PK,k2.PK);
    var pk = combine(PKs); 


    


    //test tally
    var Tc = encrypt(params,pk.PK, 3);
    var D1 = partDec(k1.SK, Tc);
    var D2 = partDec(k2.SK, Tc);
    var Ds = new Array(D1,D2);
    var tar = tally(params, Ds, Tc);


	$("#addec").click(function(){
		
		var c1 = encrypt(params,keys.PK, 3);
	    var c2 = encrypt(params,keys.PK, 4);
	    var cArray = new Array(c1,c2);

	    var bytes = [];

		var queryparams = "?C1=";
		c1.C1.toBytes(bytes);
		queryparams += bytes.toString();

		queryparams += "&C2=";
		c1.C2.toBytes(bytes);
		queryparams += bytes.toString();

		queryparams += '&C1=';
		c2.C1.toBytes(bytes);
		queryparams += bytes.toString();

		queryparams += '&C2=';
		c2.C2.toBytes(bytes);
		queryparams += bytes.toString();

		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {


			if (this.readyState == 4 && this.status == 200) {
			    
			    var localAdd = add(cArray);
			    var localM = decrypt(params, keys.SK, localAdd);
			    
			    console.log(localM);
		  		document.getElementById("addecLocal").innerHTML = JSON.stringify(localAdd);


		  		console.log("Request: /addec"+queryparams);
		  		document.getElementById("addecServer").innerHTML = this.responseText;

		  		//build object from server
		  		var temp = JSON.parse(this.responseText);

		  		//the values need to be copied in otherwise decryption doesn't work
		  		var ctx = new CTX("BN254CX");  
		        var s1=new ctx.ECP();
		        var s2=new ctx.ECP();
		        //copy the first cipher
		        s1.copy(temp.C1);
		        s2.copy(temp.C2);
		  		var serverAdd = {
	  			       C1:s1,
	  			       C2:s2
		  		}
		  		
		  		var serverM = decrypt(params, keys.SK, serverAdd);
		  		console.log(serverM);
		
		  		document.getElementById("addecResult").innerHTML = "Local results: " + localM.M + ", Server results: " + serverM.M + "\n JSON string match: " + (JSON.stringify(localAdd) == this.responseText);

			}
		};
		xhttp.open("GET", "/addec"+queryparams, true);
		xhttp.send();
	})

	
});
</script>

</body>
</html>
